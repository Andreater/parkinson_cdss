---
title: "Untitled"
author: "Andrea Termine"
date: "2022-10-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r config}
# plant a seed
set.seed(12345)

# Path to config
config = yaml::read_yaml(file = "../config/config r.yaml", eval.expr=TRUE)
```

```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
# Import custom functions
source(config$default$udfPath)
source("udf.R")
source("wide_rm_tester_functions.R")
source("testfix.R")
## Required Packages
pkg = config$default$pkg

## Now load or install & load all // Cran version
load_packages(pkgs = pkg)
# cat("Libraries Imported")
rm(pkg,p)
```

## Data Import

```{r Basic, warning=FALSE}
# Metadata ----
## rna Metadata  ----
meta_rna      = readRDS(config$metadata$rnaMetaPath)
## Analytic Cohort metadata ----
meta_analytic = readRDS(config$metadata$analyticMetaPath)
## PD Labels from M3C ----
pd_labels = read.xlsx(config$metadata$m3cLabelsPath)
pd_labels = pd_labels %>% mutate(label = ifelse(label == 1, "PDC1", "PDC2"))
## Codebook for columns (3 sheets)
codebookNames   = readxl::excel_sheets(path = config$metadata$codebook)
codebook        = vector(mode = "list", length = length(codebookNames))
names(codebook) = codebookNames
for (i in 1:length(codebook)) {codebook[[i]] = read.xlsx(config$metadata$codebook, sheet = i)}
rm(codebookNames)

# Actual Biomedical data ----
## Biospec
medhist = batch_csv_import(pathDir = config$medicalHistory$path)

## Basic cohort data
core_set = left_join(meta_rna %>% mutate(PATNO = as.character(PATNO)) %>% 
                       dplyr::select(PATNO, GENDER, Cohort, Subgroup, CLINICAL_EVENT) %>% filter(CLINICAL_EVENT == "BL"),
                     pd_labels, by = "PATNO") %>% 
  mutate(label = ifelse(is.na(label), Cohort, label)) %>% 
  relocate(CLINICAL_EVENT, .after = label) %>% 
  dplyr::select(- CLINICAL_EVENT)

core_set %>% 
  xtabs(~ label, data = .)
```

```{r parameters}
# Select a period spanning from 0 to 2 years every six month
selected_period = c("BL", "V02", "V04", "V05", "V06")
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06")

#df    = medication$data[[1]]
gp      = "label"
tp      = "EVENT_ID"
id      = "PATNO"
y       = "value"
REML    = FALSE
```

```{r}
# Removing empty dataframes (they were empty in the PPMI)
medhist = medhist %>% 
  discard(.x = ., .p = ~ plyr::empty(.x) == TRUE)
```

## TAU substudy adverse event telephone assessment

Removed due to low sample size in the selected timepoints

```{r}
tau_substudy_adverse_event_telephone_assessment = medhist$x_tau_substudy__adverse_event_telephone_assessment
tau_substudy_adverse_event_telephone_assessment = tau_substudy_adverse_event_telephone_assessment %>%
  dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
```

## Adverse event log 

This is a bit particular, so we will do some manual checks. The first thing we can say (tab1) is that most of the adverse events are reported in the logs and BL. There is no data for V06. There some missing values not coded and we corrected them.
Then we filtered the adverse event that were not caused by experimental procedure from PPMI (aerelat <= 2)

We tested if the frequency of adverse event was different between groups. Then we inspected the if the frequency of the adverse event x category of system affected was different by groups. Then we checked the severity differences between groups.

We found that PDC1 has lower rate of vascular events  when compared to PDC2 and HC

```{r}
adverse_event_log = medhist$adverse_event_log
adverse_event_log = adverse_event_log %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))

# Placeholder for dvs

# Timepoint sanity check but not filtering
adverse_event_log %>% 
  group_by(EVENT_ID) %>% 
  tally() %>% 
  arrange(-n)

prova = left_join(core_set %>% dplyr::select(PATNO, label),
          adverse_event_log %>%
            mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
  filter(!is.na(EVENT_ID)) %>% 
  mutate(across(.cols = everything(), .fns = ~ na_if(.x, "")))

prova = prova %>% 
  filter(AERELAT <=2)

# how many subjects left?
prova %>% 
  dplyr::select(PATNO,label) %>% 
  distinct() %>% 
  group_by(label) %>% 
  tally()

# Are the groups different for ADverse event severity? We are considering only those that are not related to PPMI procedures
severity = prova %>% 
  xtabs(~ AESEVER + label, data = .) %>% 
  fisher.test() %>% 
  glance() %>% 
  mutate(comparison = "all")

# Filtering the high level categories to keep only most frequent categories of adverse events (n>10)
categories = prova %>% 
  group_by(SOCABBR1) %>% 
  tally() %>% 
  arrange(-n) %>% 
  filter(n > 10) %>% 
  .$SOCABBR1

comparison_list = list(c("PDC1", "PDC2"),
     c("PDC1", "Healthy Control"),
     c("PDC2", "Healthy Control"),
     c("PDC1", "Prodromal"),
     c("PDC2", "Prodromal"))
storage = vector(mode = "list", length = length(comparison_list))

for (i in 1:length(comparison_list)) {
  storage[[i]] = try(prova %>%
    filter(SOCABBR1 %in% categories) %>% 
    filter(label %in% comparison_list[[i]]) %>% 
    xtabs(~ SOCABBR1 + label, data = .) %>% 
    fisher.test() %>% 
    glance() %>% 
    mutate(comparison = paste(comparison_list[[i]], collapse = "-"),
           dv         = "SOCABBR1"))
}

type = storage %>% 
  keep(.x = .,
       .p = ~ any(class(.x) %in% "data.frame")) %>% 
  reduce(bind_rows)

# Are the groups different for frequency of adverse event?
testing = left_join(prova %>% 
    dplyr::select(PATNO, label) %>% 
    group_by(label) %>% 
    tally() %>% 
    rename(frequency_of_adverse_events = n),
  core_set %>% 
    xtabs(~ label, data = .) %>% as_tibble()) %>% 
  mutate(frequency_of_not_adverse_events = n - frequency_of_adverse_events)


storage = vector(mode = "list", length = length(comparison_list))
for (i in 1:length(comparison_list)) {
  temp = testing %>% 
  filter(label %in% comparison_list[[i]])
  storage[[i]] = try(prop.test(x = c(temp[[2]][1], temp[[2]][2]), n = c(temp[[3]][1], temp[[3]][2])) %>% 
    glance() %>% 
    mutate(method     = "two sample proportion test",
           comparison = paste(comparison_list[[i]], collapse = "-"),
           dv         = "frequency_of_adverse_event") %>% 
    rename(prop_group_1 = estimate1, 
           prop_group_2 = estimate2))
}
frequency_of_adverse = storage %>% keep(.x = .,
                 .p = ~ any(class(.x) %in% "data.frame")) %>% 
  reduce(bind_rows)

adverse_event_res = bind_rows(severity %>% mutate(dv = "AESEVER"), type, frequency_of_adverse)

dvs = c("AESEVER", "SOCABBR1")
# Adding information about the dependent variable
y_annotation = codebook$data_dictionary_annotated %>% 
  filter(ITM_NAME %in% dvs) %>% 
  dplyr::select(ITM_NAME, DSCR, ITM_TYPE) %>% 
  rename(dv = ITM_NAME)

adverse_event_res = left_join(adverse_event_res, y_annotation, by = "dv")
rm(y_annotation)

adverse_event_res = adverse_event_res %>% dplyr::select(dv, DSCR, ITM_TYPE, comparison, everything())

 
## Which categories are different between PDC1 PDC2
prova %>%
    filter(SOCABBR1 %in% categories) %>% 
    filter(label %in% comparison_list[[1]]) %>% 
    xtabs(~ SOCABBR1 + label, data = .)

temp1 = left_join(prova %>%
    filter(SOCABBR1 %in% categories) %>% 
    filter(label %in% comparison_list[[1]]) %>%
    xtabs(~ SOCABBR1 + label, data = .) %>% 
  as_tibble() %>% 
  rename(frequency_of_adverse_event = n),
  core_set %>% 
    xtabs(~ label, data = .) %>% as_tibble()) %>%
  group_by(SOCABBR1) %>% 
  nest()

temp1 = temp1 %>% 
  mutate(test = map(.x = data, .f = ~ prop.test(x = c(.x[[2]][1], .x[[2]][2]), n = c(.x[[3]][1], .x[[3]][2])) %>% 
                                                  glance() %>% 
                                                  mutate(method     = "two sample proportion test",
                                                         comparison = paste(comparison_list[[i]], collapse = "-"))
                    )
         ) %>% 
  unnest(test) %>% 
  mutate(comparison = "PDC1-PDC2") %>% 
  relocate(comparison, .before = SOCABBR1)
temp2 = left_join(prova %>%
    filter(SOCABBR1 %in% categories) %>% 
    filter(label %in% comparison_list[[2]]) %>%
    xtabs(~ SOCABBR1 + label, data = .) %>% 
  as_tibble() %>% 
  rename(frequency_of_adverse_event = n),
  core_set %>% 
    xtabs(~ label, data = .) %>% as_tibble()) %>%
  group_by(SOCABBR1) %>% 
  nest()

temp2 = temp2 %>% 
  mutate(test = map(.x = data, .f = ~ prop.test(x = c(.x[[2]][1], .x[[2]][2]), n = c(.x[[3]][1], .x[[3]][2])) %>% 
                                                  glance() %>% 
                                                  mutate(method     = "two sample proportion test",
                                                         comparison = paste(comparison_list[[i]], collapse = "-"))
                    )
         ) %>% 
  unnest(test) %>% 
  mutate(comparison = "PDC1-Healthy Control") %>% 
  relocate(comparison, .before = SOCABBR1)

post_hoc_for_socabbr1 = bind_rows(temp1, temp2)

# Frequencies in SOCABBR1 that were significant ----
frequencies_of_socabbr1 = list(pdc1_pdc2 =
                                 left_join(prova %>%
                                             filter(SOCABBR1 %in% categories) %>% 
                                             filter(label %in% comparison_list[[1]]) %>%
                                             xtabs(~ SOCABBR1 + label, data = .) %>% 
                                             as_tibble() %>% 
                                             rename(frequency_of_adverse_event = n),
                                           core_set %>% 
                                             xtabs(~ label, data = .) %>% as_tibble()) %>% 
                                 mutate(adverse_event_prop = frequency_of_adverse_event/n),
                               pdc1_hc = left_join(prova %>%
                                                     filter(SOCABBR1 %in% categories) %>% 
                                                     filter(label %in% comparison_list[[2]]) %>%
                                                     xtabs(~ SOCABBR1 + label, data = .) %>% 
                                                     as_tibble() %>% 
                                                     rename(frequency_of_adverse_event = n),
                                                   core_set %>% 
                                                     xtabs(~ label, data = .) %>% as_tibble()) %>% 
                                 mutate(adverse_event_prop = frequency_of_adverse_event/n))


save(post_hoc_for_socabbr1, frequencies_of_socabbr1, adverse_event_res, file = file.path(config$subjectCharacteristics$scexportdir, "adverse_event.rdata"))
```

## Concomitant medicines

Are the group different by indication category? We found several different keywords.

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06", "R06", "LOG")

meds = medhist$concomitant_medication_log
meds = meds %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
meds = left_join(core_set %>% dplyr::select(PATNO, label),
                 meds %>%
                   mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
  filter(!is.na(EVENT_ID)) %>%
  mutate(across(.cols = everything(), .fns = ~ na_if(.x, "")))

ind_text = meds %>% 
  filter(!is.na(CMINDC_TEXT)) %>% 
  group_by(PATNO) %>% 
  mutate(text = paste(CMINDC_TEXT, collapse = " ")) %>% 
  dplyr::select(PATNO, label, text) %>% 
  distinct()

# NLP
ind_text = ind_text %>% 
  mutate(text = tolower(text),
         text = str_remove_all(text, "[:punct:]"))

corpus = corpus(x          = ind_text,
                text_field ="text")
summary(corpus)

## Warning, this must be uploaded or the chunk needs to skipped
spacy_lemma = readRDS(file = paste("spacy lemma.rds", sep = ""))




storage = vector(mode = "list", length(comparison_list))

for (i in 1:length(comparison_list)) {
  names(storage)[i] = paste(comparison_list[[i]], collapse = "_") %>% tolower()
  # dfm creation pipeline for keyness analysis
  dfm_k =
    corpus %>%
    corpus_subset(label %in% comparison_list[[i]]) %>%
    tokens(remove_punct   = TRUE,
           remove_numbers = TRUE,
           split_hyphens  = TRUE,
           remove_symbols = TRUE,
           remove_url     = TRUE,
           padding        = FALSE) %>%
    tokens_remove(pattern = stopwords(language = "en",
                                      source   = "snowball")) %>%
    tokens_replace(pattern     = spacy_lemma$token,
                   replacement = spacy_lemma$lemma) %>%
    dfm() %>%
    dfm_group(groups = label) %>%
    dfm_trim(min_termfreq  = 10,
             max_termfreq  = NULL,
             termfreq_type = "count",
             min_docfreq   = 2,
             max_docfreq   = NULL,
             docfreq_type  = "count")
  
  # Differential keyness analysis
  keys = textstat_keyness(dfm_k, target = dfm_k$label == comparison_list[[i]][[1]])
  keys = keys %>% 
    as.data.frame() %>% 
    filter(p < 0.05) %>% 
    mutate(index = ifelse(chi2 < 0,
                          paste("Less frequent in", comparison_list[[i]][1]), 
                          paste("More frequent in", comparison_list[[i]][1]))) %>% 
    rename(High = n_target,
           Low  = n_reference) %>% 
    pivot_longer(cols      = c("High", "Low"), 
                 names_to  = "label",
                 values_to = "frequency") %>%
    mutate(label = ifelse(label == "High", comparison_list[[i]][1], comparison_list[[i]][2]))
  
  plot = keys %>% 
    ggplot() + 
    aes(x = reorder(feature, -p), y = frequency, colour = label) + 
    geom_point() +
    coord_flip() +
    theme_grey() +
    labs(x = "Keyword",
         y = "Frequency",
         colour = "") + 
    facet_wrap(~ index, scales = "free")
  storage[[i]] = keys
  ggsave(filename = file.path(config$subjectCharacteristics$scexportdir, paste0("Keyness ",
                                                                                comparison_list[[i]][[1]], "_", comparison_list[[i]][[2]],
                                                                                ".png")),
       plot = plot, device = "png", width = 18, height = 20, units = "cm", dpi = 300)
}
save(ind_text = ind_text, storage, file = file.path(config$subjectCharacteristics$scexportdir,
                                                    "indication for concomitant medicines data and res.rdata"))

```

## Freeze fall

This dataset has not enough observations in the selected period. Switchking to the chisq/glm approach

```{r}

# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06")

freeze_fall = medhist$determination_of_freezing_and_falls
freeze_fall = freeze_fall %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE", "PTCGBOTH"))
dvs         = names(freeze_fall)[3:ncol(freeze_fall)]
freeze_fall = left_join(core_set %>% dplyr::select(PATNO, label),
                                freeze_fall %>%
                                  mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
    dplyr::select(PATNO, label, EVENT_ID,everything())

freeze_fall = freeze_fall %>% 
  pivot_longer(cols = all_of(dvs),
               names_to = "dv",
               values_to = "value") %>% 
    mutate(value    = na_if(value, ""),
           value    = na_if(value,"UR"),
           value    = na_if(value, "Indeterminate"),
           EVENT_ID = na_if(EVENT_ID, "")) %>%
    filter(!is.na(EVENT_ID)) %>% 
  group_by(EVENT_ID, dv) %>% 
  nest() %>% 
  arrange(EVENT_ID, dv) %>% 
  mutate(fit= map(.x = data, .f = ~ try(glm(formula = value ~ label, data = .x, family = "binomial"))),
         fit_converged = map(.x = fit, .f = ~ any(class(.x) != "try-error"))) %>% 
  filter(fit_converged == TRUE) %>% 
  mutate(anova = map(.x=fit, .f=~ car::Anova(.x, type = "III") %>% tidy() )) %>% 
  unnest(anova) %>% 
  mutate(post_hoc = map(.x= fit, .f = ~ emmeans(.x,  specs = pairwise ~ label, adjust = "tukey")),
         post_hoc_df = map(.x=post_hoc, .f=~ .x$contrasts %>% 
                             tidy() %>%
                             dplyr::select(-term) %>% 
                             rename_with(.cols = c("df",
                                                   "statistic",
                                                   contains("p.value")), .fn = ~ paste(.x, "post_hoc", sep = "_")))) %>% 
  unnest(post_hoc_df)


saveRDS(freeze_fall, file = file.path(config$subjectCharacteristics$scexportdir, "freeze fall by timepoint glm approach.rds"))

```

## Features of parkinsonism

Only Prodromal cohort is present in the selected timepoint. Not testable using the RM method. 
Switching to the chisq/glm approach.

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06")

features_of_parkinsonism = medhist$features_of_parkinsonism
features_of_parkinsonism = features_of_parkinsonism %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
dvs         = names(features_of_parkinsonism)[3:ncol(features_of_parkinsonism)]

features_of_parkinsonism = left_join(core_set %>% dplyr::select(PATNO, label),
                                features_of_parkinsonism %>%
                                  mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
    dplyr::select(PATNO, label, EVENT_ID,everything())

features_of_parkinsonism = features_of_parkinsonism %>% 
  pivot_longer(cols = all_of(dvs),
               names_to = "dv",
               values_to = "value") %>% 
    mutate(value    = na_if(value, ""),
           value    = na_if(value,"UR"),
           value    = na_if(value, "Indeterminate"),
           EVENT_ID = na_if(EVENT_ID, "")) %>%
    filter(!is.na(EVENT_ID)) %>% 
  group_by(EVENT_ID, dv) %>% 
  nest() %>% 
  arrange(EVENT_ID, dv) %>% 
  mutate(fit= map(.x = data, .f = ~ try(glm(formula = value ~ label, data = .x, family = "binomial"))),
         fit_converged = map(.x = fit, .f = ~ any(class(.x) != "try-error"))) %>% 
  filter(fit_converged == TRUE) %>% 
  mutate(anova = map(.x=fit, .f=~ car::Anova(.x, type = "III") %>% tidy() )) %>% 
  unnest(anova) %>% 
  mutate(post_hoc = map(.x= fit, .f = ~ emmeans(.x,  specs = pairwise ~ label, adjust = "tukey")),
         post_hoc_df = map(.x=post_hoc, .f=~ .x$contrasts %>% 
                             tidy() %>%
                             dplyr::select(-term) %>% 
                             rename_with(.cols = c("df",
                                                   "statistic",
                                                   contains("p.value")), .fn = ~ paste(.x, "post_hoc", sep = "_")))) %>% 
  unnest(post_hoc_df)


saveRDS(features_of_parkinsonism, file = file.path(config$subjectCharacteristics$scexportdir, "features of parkinsonism by timepoint glm approach.rds"))
```

## GENERAL physical_exam

Not enough rm observations in the selected period. Switch to timepoint based estimation

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V06", "V08")

general_physical_exam = medhist$general_physical_exam
general_physical_exam = general_physical_exam %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))

general_physical_exam = left_join(core_set %>% dplyr::select(PATNO, label),
                                general_physical_exam %>%
                                  mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
    dplyr::select(PATNO, label, EVENT_ID,everything()) %>% 
  rename(value = ABNORM) %>% 
    mutate(value    = na_if(value, ""),
           value    = na_if(value,"UR"),
           value    = na_if(value, "Indeterminate"),
           value    = na_if(value, 2),
           EVENT_ID = na_if(EVENT_ID, "")) %>%
    filter(!is.na(EVENT_ID))

general_physical_exam = general_physical_exam %>% 
  group_by(EVENT_ID, PECAT) %>% 
  nest() 


general_physical_exam = general_physical_exam %>% 
  mutate(fit           = map(.x = data, .f = ~ try(glm(formula = value ~ label, data = .x, family = "binomial"))))

general_physical_exam =  general_physical_exam %>% 
  mutate(fit_converged = map(.x = fit, .f = ~ any(class(.x) != "try-error")))

general_physical_exam  = general_physical_exam %>% 
  filter(fit_converged == TRUE) %>% 
  mutate(anova = map(.x=fit, .f=~ car::Anova(.x, type = "III") %>% tidy() )) %>% 
  unnest(anova)

general_physical_exam = general_physical_exam %>% 
  mutate(post_hoc = map(.x= fit, .f = ~ emmeans(.x,  specs = pairwise ~ label, adjust = "tukey")))

general_physical_exam = general_physical_exam %>% 
  mutate(post_hoc_df = map(.x=post_hoc, .f=~ .x$contrasts %>% 
                             tidy() %>%
                             dplyr::select(-term) %>% 
                             rename_with(.cols = c("df",
                                                   "statistic",
                                                   contains("p.value")), .fn = ~ paste(.x, "post_hoc", sep = "_") )))

general_physical_exam = general_physical_exam %>% 
  unnest(post_hoc_df)

saveRDS(general_physical_exam, file.path(config$subjectCharacteristics$scexportdir, "general physical exam by timepoint.rds"))
```

## Medical condition log

We have to do the same NLP analysis

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V06", "V08")

medical_conditions_log = medhist$medical_conditions_log
medical_conditions_log = medical_conditions_log %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
medical_conditions_log = left_join(core_set %>% dplyr::select(PATNO, label),
                                medical_conditions_log %>%
                                  mutate(PATNO = as.character(PATNO)), by = "PATNO")

medical_conditions_log = medical_conditions_log %>% 
  filter(!is.na(MHTERM)) %>%
    filter(!is.na(EVENT_ID)) %>%
  mutate(across(.cols = everything(), .fns = ~ na_if(.x, ""))) %>% 
  group_by(PATNO) %>% 
  mutate(text = paste(MHTERM, collapse = " ")) %>% 
  dplyr::select(PATNO, label, text) %>% 
  distinct() %>% 
  mutate(text = tolower(text),
         text = str_remove_all(text, "[:punct:]"))

corpus = corpus(x          = medical_conditions_log,
                text_field ="text")

storage = vector(mode = "list", length(comparison_list))

for (i in 1:length(comparison_list)) {
  names(storage)[i] = paste(comparison_list[[i]], collapse = "_") %>% tolower()
  # dfm creation pipeline for keyness analysis
  dfm_k =
    corpus %>%
    corpus_subset(label %in% comparison_list[[i]]) %>%
    tokens(remove_punct   = TRUE,
           remove_numbers = TRUE,
           split_hyphens  = TRUE,
           remove_symbols = TRUE,
           remove_url     = TRUE,
           padding        = FALSE) %>%
    tokens_remove(pattern = stopwords(language = "en",
                                      source   = "snowball")) %>%
    tokens_replace(pattern     = spacy_lemma$token,
                   replacement = spacy_lemma$lemma) %>%
    dfm() %>%
    dfm_group(groups = label) %>%
    dfm_trim(min_termfreq  = 10,
             max_termfreq  = NULL,
             termfreq_type = "count",
             min_docfreq   = 2,
             max_docfreq   = NULL,
             docfreq_type  = "count")
  
  # Differential keyness analysis
  keys = textstat_keyness(dfm_k, target = dfm_k$label == comparison_list[[i]][[1]])
  keys = keys %>% 
    as.data.frame() %>% 
    filter(p < 0.05) %>% 
    mutate(index = ifelse(chi2 < 0,
                          paste("Less frequent in", comparison_list[[i]][1]), 
                          paste("More frequent in", comparison_list[[i]][1]))) %>% 
    rename(High = n_target,
           Low  = n_reference) %>% 
    pivot_longer(cols      = c("High", "Low"), 
                 names_to  = "label",
                 values_to = "frequency") %>%
    mutate(label = ifelse(label == "High", comparison_list[[i]][1], comparison_list[[i]][2]))
  
  plot = keys %>% 
    ggplot() + 
    aes(x = reorder(feature, -p), y = frequency, colour = label) + 
    geom_point() +
    coord_flip() +
    theme_grey() +
    labs(x = "Keyword",
         y = "Frequency",
         colour = "") + 
    facet_wrap(~ index, scales = "free")
  storage[[i]] = keys
  ggsave(filename = file.path(config$subjectCharacteristics$scexportdir, paste0("Keyness medical condition",
                                                                                comparison_list[[i]][[1]], "_", comparison_list[[i]][[2]],
                                                                                ".png")),
       plot = plot, device = "png", width = 18, height = 20, units = "cm", dpi = 300)
}
save(ind_text = ind_text, storage, file = file.path(config$subjectCharacteristics$scexportdir,
                                                    "indication for medical condition log data and res.rdata"))
```

## Neurological Exam 

Not enough rm observation x timepoint, so we are performing a chisq x timepoint strategy

```{r}
comparison_list = list(c("PDC1", "PDC2"),
                       c("PDC1", "Healthy Control"),
                       c("PDC2", "Healthy Control"),
                       c("PDC1", "Prodromal"),
                       c("PDC2", "Prodromal"))

dvs = names(neurological_exam)[str_detect(names(neurological_exam), "SP")]
storage = vector(mode = "list", length = length(dvs))
for (i in 1:length(dvs)) {
  tryCatch({
    dv         = dvs[i]
    formula    = paste("~", dv, "+ label") %>% as.formula()
    # Select a period spanning from 0 to 2 years every year
    neurological_exam = medhist$neurological_exam
    neurological_exam$EVENT_ID %>% unique()
    neurological_exam = neurological_exam %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
    neurological_exam = left_join(core_set %>% dplyr::select(PATNO, label),
                                  neurological_exam %>%
                                    mutate(PATNO = as.character(PATNO)), by = "PATNO")
    
    
    storage[[i]] = neurological_exam %>% 
      group_by(EVENT_ID) %>% 
      nest() %>% 
      mutate(tab = map(.x = data, .f = ~ .x %>%
                         dplyr::select(PATNO, label, all_of(dv)) %>%  
                         distinct() %>% 
                         xtabs(formula, data = .)),
             are_there_enough_groups = map(.x = data, .f = ~ length(unique(.x$label)) > 1)) %>% 
      filter(are_there_enough_groups == TRUE) %>% 
      mutate(test = map(.x = tab, .f = ~ .x %>% 
                          chisq.test() %>% 
                          tidy())) %>% 
      unnest(test) %>%
      ungroup() %>%  
      mutate(p.adjusted = p.adjust(p.value, "fdr")) %>% 
      relocate(p.adjusted, .before = parameter) %>% 
      mutate(effsize = map(.x = tab, .f = ~ .x %>% cramer_v)) %>% 
      unnest(effsize) %>% 
      mutate(magnitude  = case_when(effsize <= 0.2 ~ "small",
                                    effsize > 0.2 & effsize <= 0.6 ~ "moderate",
                                    effsize > 0.6 ~ "large")) %>% 
      mutate(comparison = "all",
             dv         = dv)
  },
  error=function(e){cat("ERROR :",conditionMessage(e), "\n")})
}



neurological_exam = storage %>% 
  reduce(bind_rows)


saveRDS(neurological_exam, file = file.path(config$subjectCharacteristics$scexportdir, "neurological_exam.rds"))
```

## Surgery for PD

This should be a difference of frequencies

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06")
surgery_for_pd = medhist$surgery_for_pd_log
surgery_for_pd$EVENT_ID %>% unique()
surgery_for_pd = surgery_for_pd %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
surgery_for_pd = left_join(core_set %>% dplyr::select(PATNO, label),
                                surgery_for_pd %>%
                                  mutate(PATNO = as.character(PATNO)), by = "PATNO")

surgical_test = 
left_join(surgery_for_pd %>% 
  filter(label %in% c("PDC1", "PDC2")) %>%
  filter(!is.na(PDSURGDT)) %>% 
  group_by(label) %>% 
  tally() %>% 
  rename(frequency_of_surgery = n),
surgery_for_pd %>% 
  filter(label %in% c("PDC1", "PDC2")) %>%
  group_by(label) %>% 
  tally())

surgery_res = prop.test(x = c(surgical_test$frequency_of_surgery[1], surgical_test$frequency_of_surgery[2]),
          n = c(surgical_test$n[1], surgical_test$n[2])) %>% 
  glance() %>% 
  mutate(comparison = "PDC1-PDC2",
         dv         = "frequency_of_surgery",
         .before    = estimate1) %>% 
  rename(prop_group_1 = estimate1,
         prop_group_2 = estimate2)


saveRDS(surgery_res, file = file.path(config$subjectCharacteristics$scexportdir, "surgery res PD only.rds"))
```

## Neurological Exam 

this works

```{r}
# Select a period spanning from 0 to 2 years every year
selected_period = c("BL", "V04", "V06")
vital_signs = medhist$vital_signs
vital_signs$EVENT_ID %>% unique()
vital_signs = vital_signs %>% dplyr::select(-c("INFODT", "REC_ID", "PAG_NAME", "ORIG_ENTRY", "LAST_UPDATE"))
dvs               = names(vital_signs)[3:ncol(vital_signs)]

vital_signs = first_wrangler(data = vital_signs, custom_gp_removal = F)
vital_signs$value %>% unique()
vital_signs = second_wrangler(data = vital_signs)

#neurological_exam = neurological_exam %>% mutate(ITM_TYPE = "CHAR")
#trail_making_ab$ITM_TYPE[trail_making_ab$dv == "STATOT"] = "NUMBER"
vital_signs = third_tester(data = vital_signs)

saveRDS(vital_signs, file = file.path(config$subjectCharacteristics$scexportdir, "vital signs.rds"))
```


