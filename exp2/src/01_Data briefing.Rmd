---
title: "Data Analysis"
author: "Andrea Termine"
date: "2022-10-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r config}
# plant a seed
set.seed(12345)

# Path to config
config = yaml::read_yaml(file = "../config/config r.yaml", eval.expr=TRUE)
```

```{r libraries, message=FALSE, warning=FALSE, include=FALSE}
# Import custom functions
source(config$default$udfPath)
source("udf.R")
source("wide_rm_tester_functions.R")
## Required Packages
pkg = config$pkg

## Now load or install & load all // Cran version
load_packages(pkgs = pkg)
# cat("Libraries Imported")
rm(pkg,p)
```

## Data Import

- Metadata 
  - RNAseq          [V]
  - Analytic Cohort [V]
  - PD labels (M3C) [V]
  - codebook        [V]
  
- Actual data
 - Biospecimen             [V]
 - Medical History         [V]
 - Motor_Assessments       [V]
 - Non Motor Assessments   [V]
 - Subject Characteristics [V]
 
- Excluded from the first analysis iteration
 - Curated_Data_Cuts
 - DaTSCAN
 - Follow_Up_persons_w_Neurologic_Disease
 - PPMI_Online
 - Verily_Study_Watch
 
NB: these data were excluded from this analysis and the reasons were explained in [here](https://docs.google.com/document/d/1sWAzx_V1ggMrYBEIf3u0ipBktHjf4bbBkttmPDRoq3w/edit#heading=h.6ajalzwdwoyq)
  
```{r Basic, warning=FALSE}
# Metadata ----
## rna Metadata  ----
meta_rna      = readRDS(config$metadata$rnaMetaPath)
## Analytic Cohort metadata ----
meta_analytic = readRDS(config$metadata$analyticMetaPath)
## PD Labels from M3C ----
pd_labels     = read.xlsx(config$metadata$m3cLabelsPath)
## Codebook for columns (3 sheets)
codebookNames   = readxl::excel_sheets(path = config$metadata$codebook)
codebook        = vector(mode = "list", length = length(codebookNames))
names(codebook) = config$metadata$codebookNames
for (i in 1:length(codebook)) {codebook[[i]] = read.xlsx(config$metadata$codebook, sheet = i)}

# Actual Biomedical data ----
## Biospecimen ----
biospecimen = read.csv(config$biospecimen$cr)
## Medical history ----
med_history = batch_csv_import(pathDir = config$medicalHistory$path)
## Motor Assessments ----
motor_assessment = batch_csv_import(pathDir = config$motorAssessment$path)
## Non motor Assessments ----
non_motor_assessment = batch_csv_import(pathDir = config$nonMotorAssessment$path)
## Subject characteristics ----
subject_characteristics = list(demographics   = batch_csv_import(config$subjectCharacteristics$demodir),
                               genetic_status = batch_csv_import(config$subjectCharacteristics$geneticdir),
                               other          = batch_csv_import(config$subjectCharacteristics$scdir))
```


## Build a core dataset

This core dataset included all the PD, HC, Prodromal subject at **BL**. Each subject has a label column which contains the PD clusters labels as well as the original information about cohort and subgroup. A summary table of label was printed below.

```{r}
pd_labels = pd_labels %>% mutate(label = ifelse(label == 1, "PDC1", "PDC2"))
meta_rna %>% dplyr::select(PATNO, GENDER, Cohort, Subgroup, CLINICAL_EVENT) %>% filter(CLINICAL_EVENT == "BL")
 
core_set = left_join(meta_rna %>% mutate(PATNO = as.character(PATNO)) %>% 
          dplyr::select(PATNO, GENDER, Cohort, Subgroup, CLINICAL_EVENT) %>% filter(CLINICAL_EVENT == "BL"),
          pd_labels, by = "PATNO") %>% 
  mutate(label = ifelse(is.na(label), Cohort, label)) %>% 
  relocate(CLINICAL_EVENT, .after = label) %>% 
  dplyr::select(- CLINICAL_EVENT)

core_set$label %>% table()
```

## Data Analysis

- Actual data
 - Biospecimen             [X]
 - Medical History         [X]
 - Motor_Assessments       [X]
 - Non Motor Assessments   [X]
 - Subject Characteristics [V] manca Participant status?


### A glance on medication

We noticed that some patient were on meds or deep brain stimulation when tested. We want to assess if there is a difference in the clusters.
But most of the patients has only 1 visit, the max is two visit (01 probe). 
In 02 probe you see that some timepoints are not usable because n group < 10. So we can keep only the two timepoint that have n group >= 10, (V15, V16)
```{r}
determination_dosing = left_join(pd_labels, motor_assessment$mds.updrs_part_iii_on_off_determination___dosing %>% 
                                   dplyr::select(PATNO, EVENT_ID, DBSYN, OFFEXAM, ONEXAM, PDMEDYN) %>% 
                                   filter(str_detect(EVENT_ID, pattern = paste(c("BL", "V"), collapse = "|"))) %>%
                                   mutate(PATNO = as.character(PATNO)), by = "PATNO") %>% 
  filter(!is.na(EVENT_ID)) %>% 
  arrange(EVENT_ID) 

xtabs(~ label + EVENT_ID, determination_dosing)
#01 probe
rm_subjects = determination_dosing %>% 
  group_by(PATNO) %>% 
  tally() %>% filter(n > 1) %>% .$PATNO

#02 probe
determination_dosing = determination_dosing %>% filter(PATNO %in% rm_subjects)
rm_subjects = determination_dosing %>% group_by(PATNO) %>% tally() %>% filter(n > 1) %>% .$PATNO
determination_dosing = determination_dosing %>% filter(PATNO %in% rm_subjects)
xtabs(~ label + EVENT_ID, determination_dosing)

determination_dosing = determination_dosing %>% filter(EVENT_ID %in% c("V15", "V16")) %>% 
  mutate(across(where(is.numeric), as.character))
determination_dosing = determination_dosing %>% na.omit()
xtabs(~ DBSYN + label + EVENT_ID, determination_dosing)
xtabs(~ OFFEXAM + label + EVENT_ID, determination_dosing)
xtabs(~ ONEXAM + label + EVENT_ID, determination_dosing)
xtabs(~ PDMEDYN + label + EVENT_ID, determination_dosing)
determination_dosing$PDMEDYN %>% table()
determination_dosing$ONEXAM %>% table()
dvs = c("DBSYN", "OFFEXAM", "ONEXAM", "PDMEDYN")
determination_dosing = determination_dosing %>% 
  mutate(across(.cols = all_of(dvs), as.factor))


df = df_storage$mds_updrs_part_iii %>% filter(label != "Prodromal")

fit = clmm(formula = as.factor(PDTRTMNT) ~ label * EVENT_ID + (1|PATNO), data = df)
fit = glmer(formula = as.factor(PDTRTMNT) ~ label * EVENT_ID + (1|PATNO), data = df, family ="binomial")

xtabs(~ PDTRTMNT + label + EVENT_ID, data = df)
```



### Motor Assess
There is no control here, so we will perform only PDC1 vs PDC2.

We are assessing the quality of the timepoints prior to testing. We think that timepoint with n < 10 and timepoints with unbalanced comparisons (n per group < 10) are not usable. Therefore we will remove the variable or the timepoint.

**Il file con determination dosing dovrebbe esssere controllato a parte. Risulta vuoto e questo non va bene.**

molte vanno convertite in factor (ad eccezione del NPTOT)

Una buona opzione sarebbe usare PDTRTMNT per controllare lo stato dei farmaci o della dbs e screenare le NP usando solo le NP TOT per avere un primo dato.

```{r}
# wrangling and quality test
df_storage        = vector(mode = "list", length = length(motor_assessment))
names(df_storage) = names(motor_assessment)
for (i in 1:length(df_storage)) {
  print(names(df_storage)[i])
  df = motor_assessment[[i]]
  df = wrangler_rm(df)
  df = quality_checker(df = df, gp = "label", tp = "EVENT_ID", id = "PATNO")
  df_storage[[i]] = df
}

# Defining the dvs list
dvs_list        = vector(mode = "list", length = length(df_storage))
names(dvs_list) = names(df_storage)
dvs_list[[1]]   = names(df_storage$gait_data___arm_swing)[sapply(df_storage$gait_data___arm_swing, is.double)]
dvs_list[[2]]   = names(df_storage$mds.updrs_part_i)[str_detect(names(df_storage$mds.updrs_part_i), "NP1")]
dvs_list[[3]]   = names(df_storage$mds.updrs_part_i_patient_questionnaire)[str_detect(names(df_storage$mds.updrs_part_i_patient_questionnaire), "NP1")]
dvs_list[[4]]
dvs_list[[5]] = names(df_storage$mds.updrs_part_iv__motor_complications)[str_detect(names(df_storage$mds.updrs_part_iv__motor_complications),"NP4")]
dvs_list[[6]] = names(df_storage$mds_updrs_part_ii__patient_questionnaire)[str_detect(names(df_storage$mds_updrs_part_ii__patient_questionnaire), "NP2")]
dvs_list[[7]] = names(df_storage$mds_updrs_part_iii)[str_detect(names(df_storage$mds_updrs_part_iii), paste(c("NP3", "DYS", "NHY"),collapse = "|"))]
dvs_list[[8]] = names(df_storage$modified_schwab___england_activities_of_daily_living)[str_detect(names(df_storage$modified_schwab___england_activities_of_daily_living), "MSEADLG")]
dvs_list[[9]] = names(df_storage$neuro_qol__lower_extremity_function__mobility__._short_form)[str_detect(names(df_storage$neuro_qol__lower_extremity_function__mobility__._short_form), "NQMOB")]
dvs_list[[10]]names(df_storage$neuro_qol__upper_extremity_function_._short_form)[str_detect(names(df_storage$neuro_qol__upper_extremity_function_._short_form), "NQUE")]
dvs_list[[11]] =  c("TRBUPCHR", "WRTSMLR","VOICSFTR", "POORBAL",
                    "FTSTUCK","LSSXPRSS","ARMLGSHK","TRBBUTTN", 
                    "SHUFFLE", "MVSLOW" , "TOLDPD")
```

```{r}
wide_rm_tester(data = df, gp = gp, tp = tp, id = id, dvs = dvs, REML = REML)
```

```{r dev}
df   = df_storage$mds.updrs_part_i
gp   = "label"
tp   = "EVENT_ID"
id   = "PATNO"
dvs  = names(df_storage$gait_data___arm_swing)[sapply(df_storage$gait_data___arm_swing, is.double)]
REML = "FALSE"

y  = "NP1COG"

```

## Biospecimen 

```{r}
biospecimen$CLINICAL_EVENT %>% unique()
biospecimen$TESTNAME %>% unique()
biospecimen$TYPE %>% unique()
```

